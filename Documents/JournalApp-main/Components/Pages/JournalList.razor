@page "/journal"
@inject NavigationManager Nav

<div class="container py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Journal</h2>
        <button class="btn btn-primary" @onclick="NewEntry">
            + New Entry
        </button>
    </div>

    <!-- Search -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-9">
                    <input class="form-control"
                           placeholder="Search by title or content"
                           @bind="searchQuery"
                           @bind:event="oninput" />
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary w-100" @onclick="ApplyFilters">
                        Search
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Entries -->
    @if (FilteredEntries.Count == 0)
    {
        <div class="alert alert-info text-center">
            No journal entries found.
        </div>
    }
    else
    {
        <div class="list-group shadow-sm">
            @foreach (var entry in PagedEntries)
            {
                <div class="list-group-item">

                    <div class="d-flex justify-content-between align-items-start">
                        <div class="me-3">
                            <h5 class="mb-1">@entry.Title</h5>
                            <small class="text-muted">
                                @entry.EntryDate.ToString("dd MMM yyyy Â· HH:mm")
                            </small>
                        </div>

                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary"
                                    @onclick="() => EditEntry(entry.Id)">
                                Edit
                            </button>
                            <button class="btn btn-outline-danger"
                                    @onclick="() => DeleteEntry(entry.Id)">
                                Delete
                            </button>
                        </div>
                    </div>

                    <p class="mt-2 mb-2 text-muted">
                        @entry.ContentPreview
                    </p>

                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <span class="fs-5">@entry.MoodEmoji</span>

                        @foreach (var tag in entry.Tags)
                        {
                            <span class="badge bg-light text-dark border">
                                @tag
                            </span>
                        }
                    </div>

                </div>
            }
        </div>
    }

    <!-- Pagination -->
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="PrevPage">Previous</button>
            </li>

            <li class="page-item disabled">
                <span class="page-link">Page @currentPage of @TotalPages</span>
            </li>

            <li class="page-item @(currentPage >= TotalPages ? "disabled" : "")">
                <button class="page-link" @onclick="NextPage">Next</button>
            </li>
        </ul>
    </nav>

</div>

@code {
    private List<JournalEntryDto> entries = new();
    private string searchQuery = "";
    private int currentPage = 1;
    private int pageSize = 5;

    private List<JournalEntryDto> FilteredEntries => entries
        .Where(e => string.IsNullOrWhiteSpace(searchQuery) 
                    || e.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)
                    || e.ContentPreview.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
        .ToList();

    private List<JournalEntryDto> PagedEntries => FilteredEntries
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();

    private int TotalPages => (int)Math.Ceiling(FilteredEntries.Count / (double)pageSize);

    protected override void OnInitialized()
    {
        // Sample entries
        entries = new()
        {
            new JournalEntryDto
            {
                Id = 1,
                Title = "A Good Day",
                ContentPreview = "Today I felt productive and positive...",
                EntryDate = DateTime.Now,
                MoodEmoji = "ðŸ˜Š",
                Tags = new() { "Work", "Productivity" }
            },
            new JournalEntryDto
            {
                Id = 2,
                Title = "Evening Reflection",
                ContentPreview = "Had a calm evening reflecting on the week...",
                EntryDate = DateTime.Now.AddDays(-1),
                MoodEmoji = "ðŸ˜Œ",
                Tags = new() { "Reflection", "Personal Growth" }
            },
            new JournalEntryDto
            {
                Id = 3,
                Title = "Weekend Adventure",
                ContentPreview = "Went hiking and enjoyed nature...",
                EntryDate = DateTime.Now.AddDays(-2),
                MoodEmoji = "ðŸžï¸",
                Tags = new() { "Travel", "Nature", "Friends" }
            }
        };
    }

    private void ApplyFilters()
    {
        currentPage = 1; // reset to first page after search
    }

    private void PrevPage()
    {
        if (currentPage > 1)
            currentPage--;
    }

    private void NextPage()
    {
        if (currentPage < TotalPages)
            currentPage++;
    }

    private void EditEntry(int id) => Nav.NavigateTo($"/journal/edit/{id}");

    private void DeleteEntry(int id)
    {
        var entry = entries.FirstOrDefault(e => e.Id == id);
        if (entry != null)
        {
            entries.Remove(entry);
        }

        // Adjust page if necessary
        if (currentPage > TotalPages)
            currentPage = TotalPages;
    }

    private void NewEntry() => Nav.NavigateTo("/journal/new");

    public class JournalEntryDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string ContentPreview { get; set; } = "";
        public DateTime EntryDate { get; set; }
        public string MoodEmoji { get; set; } = "ðŸ™‚";
        public List<string> Tags { get; set; } = new();
    }
}
